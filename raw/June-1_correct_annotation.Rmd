---
title: "June-1_correct_annotation"
output: html_document
date: "2025-06-02"
---

```{r}
library(tidyverse)
library(Seurat)
library(harmony)
```

Notes from May 28 meeting:
myeloid version settled: V1.3
T cells: V1.4
lymphocytes: V1.4
whole: V1.4

Task: 
1) correct T cell and lymphocyte labels
2) increase myeloid resolution to have more macrophage subpopulations
3) adjust color palette (exclude light colors)

After T cell and lymphocyte label correction, workflow proceed to a different notebook for T cell data analysis.CD8 and CD4 subsets are created in this notebook but analyzed in a different one.


```{r}
RDSdir <- "RDS/"
```

```{r}
library(RColorBrewer)
getPalette.1 <- colorRampPalette(brewer.pal(n = 12,name = "Set3"))
pal <- c(brewer.pal(n = 12,name = "Set3"),brewer.pal(n = 12,name = "Paired"),brewer.pal(n = 8,name = "Accent"))
pal[2] <- "darkred"
pal[9] <- "grey25"
pal[23] <- "darkblue"
pal[19] <- colors()[60]
pal[13] <- "turquoise4"
pal[28] <- colors()[16]
pal[31] <- colors()[54] 
pal <- c(pal,colors()[c(85,84,83,89,45,31,41,42,26,29,10,139,107,108,120,109,119,121,143)])

pal2 <- pal[c(1:8,10,13:14,16:20, 22:25,27:30, 33:35 )] # use pal2
```

## correct T cell labels

```{r}
T_cells <- readRDS(paste0(RDSdir,"T_cells_V1p4.Rds"))
```

```{r}
colnames(T_cells@meta.data)
```
```{r}
DimPlot(T_cells, group.by = "annotation_V1")+scale_color_manual(values = pal2)
```
```{r}
table(T_cells$annotation_V1)
```

temporarily no need to update T cells (Th2? )

```{r}
FeaturePlot(T_cells, features = "Gata3") # I think it is probably Th2; 
FeaturePlot(T_cells, features = "Il4",order = T) # I think it is probably Th2; but only half of the cells are Th2-like

FeaturePlot(T_cells, features = "Il5",order = T) # I think it is probably Th2; 
FeaturePlot(T_cells, features = "Il13",order = T) # I think it is probably Th2; 

FeaturePlot(T_cells, features = "Cd8a")
FeaturePlot(T_cells, features = "Cd4")
FeaturePlot(T_cells, features = "Ccr4")
FeaturePlot(T_cells, features = "Ccr7")

FeaturePlot(T_cells, features = "Tcf7")
```


```{r}
FeaturePlot(T_cells, features = "Ncr1")
FeaturePlot(T_cells, features = "Tyrobp")
FeaturePlot(T_cells, features = "Klrb1c")
FeaturePlot(T_cells, features = "Lag3")
FeaturePlot(T_cells, features = "Prf1")
FeaturePlot(T_cells, features = "Havcr2")
FeaturePlot(T_cells, features = "Prdm1")
FeaturePlot(T_cells, features = "Gzmb")
FeaturePlot(T_cells, features = "Isg15")
```

### subcluster Cd4 and Cd8 T cells

```{r}
others <- subset(T_cells, subset = annotation_V1 %in% c("c7: gdT","c8: Proliferating")) # don't touch others
CD4 <- subset(T_cells, subset = annotation_V1 %in% c("c2: Treg","c3: Th2","c5: Th","c6: Tex"))
# isolate NKT-like with CD8
CD8 <- subset(T_cells, subset = annotation_V1 %in% c("c0: Naive CD8 T","c1: NKT-like","c4: Tem/ex"))
```

#### R1 CD4

```{r}
CD4 <- FindVariableFeatures(object = CD4, selection.method = 'mean.var.plot', mean.cutoff = c(0.0125, 5), dispersion.cutoff = c(0.5, Inf))
VariableFeatures(CD4) <-  VariableFeatures(CD4)[!grepl("^Tra|^Trb|^Igh|^Igk|Mamu-a", VariableFeatures(CD4))]
VariableFeaturePlot(CD4)
CD4 <- ScaleData(object = CD4, features = VariableFeatures(object = CD4), vars.to.regress = c("nCount_RNA", "percent.mt"))
CD4 <- RunPCA(object = CD4,
                features =  VariableFeatures(object = CD4),
                dims = 1:50)
gc()
ElbowPlot(CD4,ndims = 50)
```


```{r}
CD4 <- RunHarmony(object = CD4, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
CD4 <- RunUMAP(CD4,dims = 1:10,reduction = "harmony")
CD4 <- RunTSNE(CD4,dims = 1:10,reduction = "harmony")

CD4 <- FindNeighbors(CD4, dims = 1:10,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  CD4 <- FindClusters(object = CD4, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
CD4 <- JoinLayers(CD4)
```

```{r}
DimPlot(CD4, group.by = "RNA_snn_res.0.9")+scale_color_manual(values = pal2)
DimPlot(CD4, group.by = "annotation_V1")+scale_color_manual(values = pal2)
```
```{r}
Idents(CD4) <- "RNA_snn_res.0.9"
FeaturePlot(CD4, features = "Cd8a", label = T)
FeaturePlot(CD4, features = "Gata3", label = T)
FeaturePlot(CD4, features = c("Il13","Il5","Gata3","Tcf7"), label = T)
FeaturePlot(CD4, features = "Il4", label = T)
FeaturePlot(CD4, features = c("Gata3","Tbx21","Rorc","Bcl6"), label = T)
FeaturePlot(CD4, features = "Icos", label = T)
FeaturePlot(CD4, features = c("Pdcd1","Lag3","Prdm1","Havcr2"), label = T)
FeaturePlot(CD4, features = "Lag3", label = T)
FeaturePlot(CD4, features = c("Gzmb", "Lilrb4a","Prf1","Klrg1"), label = T)
FeaturePlot(CD4, features = c("Gzmb", "Lilrb4a","Ccl5","Serpina3f"), label = T)
```

```{r}
FeaturePlot(CD4, features = "Lef1", label = T)
```


```{r}
DotPlot(CD4, group.by = "RNA_snn_res.0.9",features = c("Cd3e","Ncr1","Tyrobp","Klrb1c","Kit","Cd4","Foxp3","Gata3","Il4","Il5","Il13","Cd8a","Lef1","Ccr7","Slamf6","Ccr4","Cd69","Il2ra","Cd44","Prf1","Gzmb","Gzmk","Lag3","Pdcd1","Tox","Havcr2","Mki67"))+scale_color_gradientn(colors = c("grey90","red2","red3"))+ RotatedAxis()

```

calculate marker for CD4

```{r}
Idents(CD4) <- "RNA_snn_res.0.9"
Cd4_markers <- FindAllMarkers(CD4)

```

```{r}
Cd4_markers_top <- Cd4_markers %>% group_by(cluster) %>% slice_max(order_by = avg_log2FC*pct.1, n = 10)
```

```{r}
DotPlot(CD4, group.by = "RNA_snn_res.0.9",features = Cd4_markers_top$gene)+scale_color_gradientn(colors = c("grey90","red2","red3"))+ RotatedAxis()
```

```{r}
Tr1_genes <- unlist(read.delim(list.files(path = "signature_mapping_Tr1", full.names = T), sep = "\t",header = F))
```

```{r}
CD4 <- AddModuleScore(CD4, features = list(Tr1_genes),name = "Tr1_signature_Houssain")
```

```{r}
FeaturePlot(CD4, features = "Tr1_signature_Houssain1")+scale_color_gradientn(colors = c("grey","white","red3"))
```

```{r}
CD4@meta.data <- CD4@meta.data %>% mutate(
  annotation_V2 = case_match(
    as.character(RNA_snn_res.0.9),
    "0" ~ "CD4_c1 Treg",
    "1" ~ "CD4_c2 Tcf7 Th1_Th2",
    "2" ~ "CD4_c3 Tex",
    "3" ~ "CD4_c4 effector Th2",
    "4" ~ "CD4_c5 Tcf7 Th2"
  )
)
# or remove prefix
```


```{r}
DimPlot(CD4, group.by = "annotation_V2")+scale_color_manual(values = pal2)
```

```{r}
saveRDS(CD4, file = paste0("RDS/V1p4_CD4.RDS"))
```


#### R1 CD8:

```{r}
CD8 <- FindVariableFeatures(object = CD8, selection.method = 'mean.var.plot', mean.cutoff = c(0.0125, 5), dispersion.cutoff = c(0.5, Inf))
VariableFeatures(CD8) <-  VariableFeatures(CD8)[!grepl("^Tra|^Trb|^Igh|^Igk|Mamu-a", VariableFeatures(CD8))]
VariableFeaturePlot(CD8)
CD8 <- ScaleData(object = CD8, features = VariableFeatures(object = CD8), vars.to.regress = c("nCount_RNA", "percent.mt"))
CD8 <- RunPCA(object = CD8,
                features =  VariableFeatures(object = CD8),
                dims = 1:50)
gc()
ElbowPlot(CD8,ndims = 50)

CD8 <- RunHarmony(object = CD8, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
CD8 <- RunUMAP(CD8,dims = 1:10,reduction = "harmony")
CD8 <- RunTSNE(CD8,dims = 1:10,reduction = "harmony")

CD8 <- FindNeighbors(CD8, dims = 1:10,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  CD8 <- FindClusters(object = CD8, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
CD8 <- JoinLayers(CD8)
```

```{r}
DimPlot(CD8, group.by = "RNA_snn_res.0.8")+scale_color_manual(values = pal2)
DimPlot(CD8, group.by = "annotation_V1")+scale_color_manual(values = pal2)
```
```{r}
DotPlot(CD8, group.by = "RNA_snn_res.0.8",features = c("Cd3e","Ncr1","Tyrobp","Klrb1c","Cd8a","Lef1","Ccr7","Slamf6","Ccr4","Cd69","Il2ra","Cd44","Isg15","Prf1","Gzmb","Gzmk","Lag3","Pdcd1","Tox","Havcr2","Mki67"))+scale_color_gradientn(colors = c("grey90","red2","red3"))+ RotatedAxis()
```
```{r}
Idents(CD8) <- "RNA_snn_res.0.8"
FeaturePlot(CD8, features = "Cd8a", label = T)
FeaturePlot(CD8, features = "Ncr1", label = T)
FeaturePlot(CD8, features = c("Ncr1","Tyrobp","Klrb1c","Prf1"), label = T)
FeaturePlot(CD8, features = "Cd3e", label = T)
FeaturePlot(CD8, features = c("Cd44","Pdcd1","Havcr2","Sell"), label = T)
FeaturePlot(CD8, features = "Icos", label = T)
FeaturePlot(CD8, features = c("Gzmb","Gzmk","Fos","Isg15"), label = T)
FeaturePlot(CD8, features = "Lag3", label = T)
FeaturePlot(CD8, features = c("Gzmb", "Lilrb4a","Prf1","Klrg1"), label = T)
```

```{r}
Idents(CD8) <- "RNA_snn_res.0.8"
Cd8_markers <- FindAllMarkers(CD8)

```

```{r}
Cd8_markers_top <- Cd8_markers %>% group_by(cluster) %>% slice_max(order_by = avg_log2FC*pct.1, n = 10)
```

```{r}
DotPlot(CD8, group.by = "RNA_snn_res.0.8",features = Cd8_markers_top$gene)+scale_color_gradientn(colors = c("grey90","red2","red3"))+ RotatedAxis()
```

```{r}
CD8@meta.data <- CD8@meta.data %>% mutate(
  annotation_V2 = case_match(
    as.character(RNA_snn_res.0.8),
    "0" ~ "Naive CD8",
    "1" ~ "NKT",
    "2" ~ "Tem/ex",
    "3" ~ "Naive CD8",
    "4" ~ "DN Klrb1",
    "5" ~ "Isg15 CD8"
  )
)
```

```{r}
DimPlot(CD8, group.by = "annotation_V2")+scale_color_manual(values = pal2)
```

```{r}
saveRDS(CD8, file = paste0("RDS/V1p4_CD8.RDS"))
```

### remerge T cells

```{r}
others$annotation_V2 <- others$annotation_V1
```


```{r}
T_cells <- merge(CD8, y = c(CD4, others))
T_cells <- JoinLayers(T_cells)
```

```{r}
T_cells <- NormalizeData(object = T_cells, normalization.method = "LogNormalize", scale.factor = 10000)
T_cells <- FindVariableFeatures(object = T_cells, selection.method = 'mean.var.plot', mean.cutoff = c(0.0125, 5), dispersion.cutoff = c(0.5, Inf))
VariableFeatures(T_cells) <-  VariableFeatures(T_cells)[!grepl("^Tra|^Trb|^Igh|^Igk|Mamu-a", VariableFeatures(T_cells))]
VariableFeaturePlot(T_cells)
T_cells <- ScaleData(object = T_cells, features = VariableFeatures(object = T_cells), vars.to.regress = c("nCount_RNA", "percent.mt"))
T_cells <- RunPCA(object = T_cells,
                features =  VariableFeatures(object = T_cells),
                dims = 1:50)
gc()
ElbowPlot(T_cells,ndims = 50)
```

```{r}

T_cells <- RunHarmony(object = T_cells, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
T_cells <- RunUMAP(T_cells,dims = 1:20,reduction = "harmony")
T_cells <- RunTSNE(T_cells,dims = 1:20,reduction = "harmony")

T_cells <- FindNeighbors(T_cells, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  T_cells <- FindClusters(object = T_cells, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
T_cells <- JoinLayers(T_cells)
```

```{r}
table(T_cells$annotation_V1)
table(T_cells$annotation_V2)
```

```{r}
T_cells@meta.data <- T_cells@meta.data %>% mutate(
  annotation_V2 = case_match(
    annotation_V1,
    "c7: gdT" ~ "gdT",
    "c8: Proliferating" ~ "Proliferating",
    .default = annotation_V2
  )
)
```

```{r}
DimPlot(T_cells, group.by = "annotation_V1")+scale_color_manual(values = pal2)
DimPlot(T_cells, group.by = "annotation_V2")+scale_color_manual(values = pal2)
```
```{r}
FeaturePlot(T_cells, features = "Tr1_signature_Houssain1")+scale_color_gradientn(colors = c("grey","white","red3"),na.value = "grey")
```

```{r}
saveRDS(T_cells, file = "RDS/T_cells_V1p4_re-merge.RDS")
```

### re-map annotation_V2 to V1p4 T cells

```{r}
T_cells <- readRDS(paste0(RDSdir,"T_cells_V1p4.Rds"))
T_cells_merge <- readRDS(paste0(RDSdir,"T_cells_V1p4_re-merge.RDS"))
```

```{r}
ncol(T_cells)
ncol(T_cells_merge)
```

```{r}
T_cells$barcode <- rownames(T_cells@meta.data)
T_cells_merge$barcode <- rownames(T_cells_merge@meta.data)
```

```{r}
meta <- left_join(T_cells@meta.data, T_cells_merge@meta.data %>% select(annotation_V2,barcode), by = "barcode")
```

```{r}
meta <- cbind(meta, T_cells@reductions$umap@cell.embeddings)
```

```{r}
ggplot(meta)+
  geom_point(aes(x = umap_1, y = umap_2, color = annotation_V2))+
  scale_color_manual(values = pal2)+
  theme_classic()
```

```{r}
rownames(meta) <- rownames(T_cells@meta.data)
```

```{r}
T_cells@meta.data <- meta
```

```{r}
saveRDS(T_cells, file = paste0(RDSdir,"T_cells_V1p4.Rds"))
```



## correct lymphocyte labels

```{r}
lymphocytes <- readRDS(file = paste0(RDSdir,"lymphocytes_V1p4.RDS"))
```


```{r}
DimPlot(lymphocytes, group.by = "annotation_V1")+scale_color_manual(values = pal2)
```
change ILC3 to ILC2; will later need to update labels via merging

```{r}
lymphocytes@meta.data  <- lymphocytes@meta.data  %>% mutate(
  annotation_V1 = case_match(annotation_V1,
                             "L10: ILC3" ~ "L10: ILC2",
                             .default = annotation_V1)
  
)
```

```{r}
DimPlot(lymphocytes, group.by = "annotation_V1")+scale_color_manual(values = pal2)
```

```{r}
lymphocytes$barcode <- rownames(lymphocytes@meta.data)
meta <- lymphocytes@meta.data 

```

```{r}
meta <- left_join(meta,T_cells@meta.data %>% select(annotation_V2, barcode), by = "barcode")
```

```{r}
table(meta$annotation_V1)
```

```{r}
meta <- meta %>% mutate(
  annotation_V2 = case_match(
    annotation_V1,
    "L0: NK" ~ "NK",
    "L10: ILC2" ~ "ILC2",
    "L7: B cells" ~ "B cells",
    .default = annotation_V2
  )
)
```

```{r}
meta <- cbind(meta, lymphocytes@reductions$umap@cell.embeddings)
```


```{r}
ggplot(meta)+
  geom_point(aes(x = umap_1, y = umap_2, color = annotation_V2), size = 0.8)+
  scale_color_manual(values = pal2)+
  theme_classic()
```

```{r}
rownames(meta) <- rownames(lymphocytes@meta.data)

```

```{r}
lymphocytes@meta.data <- meta
```

```{r}
DimPlot(lymphocytes, group.by = "annotation_V2")+scale_color_manual(values = pal2)
```

```{r}
saveRDS(lymphocytes, file = paste0(RDSdir,"lymphocytes_V1p4.RDS"))
```

## update myeloid labels



## adjust color palette

whole annotation will need to corrected after re-annotating the myeloids; clustering resolution for myeloid cells needs to be higher such that there are more macrophage clusters.

```{r}
whole <- readRDS(file = paste0(RDSdir,"whole_V1p4.RDS"))
```

```{r}
DimPlot(whole, group.by = "annotation_V1")+scale_color_manual(values = pal2)
# exclude 10th, 11th and 15th
```

## create new whole dataset


```{r}
lymphocytes <- readRDS(paste0(RDSdir,"lymphocytes_V1p4.RDS"))
myeloid <- readRDS(paste0(RDSdir,"myeloid_V1p3-2.RDS"))
```



```{r}
colnames(myeloid@meta.data)
colnames(lymphocytes@meta.data)
```
```{r}
lymphocytes$umap_1 <- NULL
lymphocytes$umap_2 <- NULL
lymphocytes$annotation_V2 <- NULL
lymphocytes$barcode <- NULL
```


```{r}
colnames(myeloid@meta.data)
colnames(lymphocytes@meta.data)
```
```{r}
whole <- merge(x= myeloid, y = lymphocytes)
whole <- JoinLayers(whole)
```


```{r}
table(whole$annotation_V1)
```



```{r}
whole <- NormalizeData(object = whole, normalization.method = "LogNormalize", scale.factor = 10000)
whole <- FindVariableFeatures(object = whole, selection.method = 'mean.var.plot', mean.cutoff = c(0.0125, 5), dispersion.cutoff = c(0.5, Inf))
VariableFeatures(whole) <-  VariableFeatures(whole)[!grepl("^Tra|^Trb|^Igh|^Igk|Mamu-a", VariableFeatures(whole))]
VariableFeaturePlot(whole)
whole <- ScaleData(object = whole, features = VariableFeatures(object = whole), vars.to.regress = c("nCount_RNA", "percent.mt"))
whole <- RunPCA(object = whole,
                features =  VariableFeatures(object = whole),
                dims = 1:50)
gc()
ElbowPlot(whole,ndims = 50)
```

```{r}
whole <- RunHarmony(object = whole, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
whole <- RunUMAP(whole,dims = 1:30,reduction = "harmony")
whole <- RunTSNE(whole,dims = 1:30,reduction = "harmony")

whole <- FindNeighbors(whole, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  whole <- FindClusters(object = whole, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
whole <- JoinLayers(whole)
```


```{r}
DimPlot(whole)
```



```{r}

DimPlot(whole, group.by = "annotation_V1",label = T, repel = T)+scale_color_manual(values = pal2)
```

```{r}
outdir <- "V1p4-2_whole_plots/"
if(!dir.exists(outdir))dir.create(outdir)
```

```{r}
table(whole$annotation_V1)
```
```{r}
whole$annotation_V1 <- factor(whole$annotation_V1, levels = c("c0: Naive CD8 T",
                                                              "c1: NKT-like",
                                                              "c2: Treg",
                                                              "c3: Th2",
                                                              "c4: Tem/ex",
                                                              "c5: Th",
                                                              "c6: Tex",
                                                              "c7: gdT",
                                                              "c8: Proliferating",
                                                              "L0: NK",
                                                              "L10: ILC2",
                                                              "L7: B cells",
                                                              "M0: Mo-Mac1",
                                                                  "M1: Mo-Mac2",
                                                                  "M2: Mo-Mac3",
                                                                  "M4: Mo-Mac4",
                                                                  "M7: Mo-Mac5",
                                                                  "M8: Proliferating Mo-Mac",
                                                                  "M11: Mo-Mac6",
                                                                  "M12: Mo-Mac7",
                                                                  "M6: Neutrophil",
                                                                  "M5: Mo-DC/monocytes",
                                                                  "M9: migDC",
                                                                  "M10: cDC1/DC2",
                                                                  "M3: Basophil/granulocytes",
                                                                  "M13: granulocytes/mast cells"))
```


```{r}
g <- DimPlot(whole, group.by = "annotation_V1",label = T, repel = T)+
  scale_color_manual(values = pal2)# + ggrepel::geom_text_repel(aes( label = ifelse(grepl("^c[0-9]*|^M7|^M0", annotation_V1), annotation_V1, "")))
g
ggsave(filename = paste0(outdir,"whole_V1p4-2_annotated_umap.pdf"), plot = g, width = 10, height = 7)

g <- DimPlot(whole, group.by = "annotation_V1",label = F, repel = T, split.by = "orig.ident")+
  scale_color_manual(values = pal2)
g
ggsave(filename = paste0(outdir,"whole_V1p4-2_annotated_umap_split.pdf"), plot = g, width = 15, height = 7)
```
```{r}
saveRDS(whole, file = paste0(RDSdir, "whole_V1p4-2.RDS"))
```


### subcompartment plots

```{r}
whole@meta.data <- whole@meta.data %>%
  mutate(highlight = case_match(
    compartment,
    "Myeloid" ~ "Myeloid",
    .default = "NA"
  ))
```

```{r}
DimPlot(whole,group.by = "highlight") + 
  scale_color_manual(values = c("Myeloid" = colorRampPalette(brewer.pal(11, "BrBG"))(8)[3],na.value = "grey90"))
g <- DimPlot(whole,group.by = "highlight") + 
  scale_color_manual(values = c("Myeloid" = colorRampPalette(brewer.pal(11, "BrBG"))(8)[3],na.value = "grey90"))
ggsave(filename = paste0(outdir,"Supp_Whole_Myeloid_unsplit.pdf"), plot = g, units = "cm",height = 10,width = 14)
```

```{r}
whole@meta.data <- whole@meta.data %>%
  mutate(highlight = case_match(
    compartment,
    "Lymphocytes" ~ "Lymphocytes",
    .default = "NA"
  ))
```

```{r}
DimPlot(whole,group.by = "highlight") + 
  scale_color_manual(values = c("Lymphocytes" = colorRampPalette(brewer.pal(11, "RdYlBu"))(8)[3],na.value = "grey90"))
g <- DimPlot(whole,group.by = "highlight") + 
  scale_color_manual(values = c("Lymphocytes" = colorRampPalette(brewer.pal(11, "RdYlBu"))(8)[3],na.value = "grey90"))
ggsave(filename = paste0(outdir,"Supp_Whole_Lymphocytes_unsplit.pdf"), plot = g, units = "cm",height = 10,width = 14)
```

```{r}

```



